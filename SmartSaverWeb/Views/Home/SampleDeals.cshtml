@model List<SmartSaverWeb.Models.Deal>
@using Microsoft.AspNetCore.WebUtilities
@{
    // Page meta info
    ViewData["Title"] = "Sample Deals";
    ViewData["MetaDescription"] = "Browse 48 fresh Amazon deals every time you visit. See savings and set alerts for the items you want.";
    ViewData["Canonical"] = "https://paynles.com/Home/SampleDeals";
    ViewData["OgImage"] = "https://paynles.com/img/sample-deals-preview.jpg"; // Optional, for social sharing

    // Amazon affiliate tag
    const string AmazonTag = "paynles-20";

    // Helper: Build tagged Amazon URL
    string BuildAmazonUrl(string asin) =>
        QueryHelpers.AddQueryString($"https://www.amazon.com/dp/{asin}", new Dictionary<string, string> { ["tag"] = AmazonTag });

    // Helper: Ensure valid image URL
    string FixImg(string img) =>
        string.IsNullOrWhiteSpace(img) ? "/img/placeholder.jpg"
        : (img.StartsWith("http", StringComparison.OrdinalIgnoreCase) ? img : $"https://m.media-amazon.com/images/I/{img}");
}


<div class="container py-5">
    <h1 class="text-center fw-bold mb-2">Sample Deals</h1>
    <p class="text-center text-muted mb-5">Real-time price drops, pulled from Amazon Lightning Deals and more.</p>
    <div class="alert alert-info text-center small m-0 py-2">
        As an Amazon Associate, we earn from qualifying purchases.
    </div>

    <div class="row row-cols-2 row-cols-md-4 g-4">
        @foreach (var item in Model)
        {
            // prices are stored in cents
            var listDollars = Math.Floor(item.CurrentPrice / 100m);
            var listCents = ((int)(item.CurrentPrice % 100)).ToString("D2");
            var dealDollars = Math.Floor(item.DealPrice / 100m);
            var dealCents = ((int)(item.DealPrice % 100)).ToString("D2");

            // correct percent off using decimals
            var pct = (item.CurrentPrice > 0)
            ? (int)Math.Round((1m - (decimal)item.DealPrice / (decimal)item.CurrentPrice) * 100m, MidpointRounding.AwayFromZero)
            : 0;
            if (pct < 0) pct = 0;

            // build affiliate URL for Amazon (DomainId==1 assumed Amazon US)
            var href = item.DomainId == 1 ? BuildAmazonUrl(item.Asin) : $"#";

            // rating like 45 -> "4.5"
            var ratingStr = item.Rating.ToString();
            var displayRating = ratingStr.Length == 1 ? $"0.{ratingStr}" : ratingStr.Insert(ratingStr.Length - 1, ".");
            <div class="col">
                <div class="card h-100 shadow-sm position-relative">
                    <img src="@FixImg(item.Image)"
                         alt="@item.Title"
                         loading="lazy"
                         decoding="async"
                         class="card-img-top"
                         style="object-fit: contain; max-height: 200px;"
                         onerror="this.src='/img/placeholder.jpg'" />
                 <div class="card-body d-flex flex-column">
                        <h6 class="fw-semibold text-truncate" title="@item.Title">
                            @(string.IsNullOrEmpty(item.Title)
                                                    ? "No Title"
                                                    : (item.Title.Length > 50 ? item.Title.Substring(0, 50) + "..." : item.Title))
                    </h6>

                        <div class="d-flex align-items-center gap-2 mb-1">
                            <span class="text-muted text-decoration-line-through">
                                $@listDollars.@listCents
                            </span>
                            <span class="text-success fw-bold">
                                $@dealDollars.@dealCents
                            </span>
                            <span class="badge bg-danger ms-auto">@pct% OFF</span>
                        </div>

                        <div class="d-flex align-items-center text-muted mb-2" style="font-size: 0.85rem;">
                        @if (item.isPrimeEarlyAccess)
                            {
                                <img src="/img/primecheck.png"
                                     alt="Prime Early Access"
                                     title="Prime Early Access"
                                     style="height: 26px; margin-right: 8px; background: #fff; padding: 2px 4px; border-radius: 4px; box-shadow: 0 0 2px rgba(0,0,0,0.2); display: inline-block; vertical-align: middle;" />
                            }
                            @displayRating ★ | @item.TotalReviews.ToString("N0") reviews
                        </div>

                        <a href="@href"
                           target="_blank"
                           rel="sponsored nofollow noopener"
                           class="btn btn-primary mt-auto w-100">
                            View Deal
                        </a>
                    </div>

                    @if (item.DomainId == 1)
                    {
                        <div class="position-absolute top-0 end-0 p-2">
                            <img src="/img/Amazonlogo.svg" alt="Amazon US" style="height: 12px; opacity: 0.8;" />
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>
